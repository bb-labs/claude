<!doctype html>
<html lang='en'>

<head>
    <title>Monsieur Claude</title>
    <meta charset='utf-8'>
    <link rel='shortcut icon' type='image/x-icon' href='favicon.ico'>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            display: grid;
            background-color: black
        }
    </style>
</head>

<body>
    <script type="module">
        import io from './tools/io.js'
        import Camera from './tools/camera.js'
        import Renderer from './tools/renderer.js'
        import Trackball from './tools/trackball.js'

        import Claude from './app/index.js'

        import Component from './components/index.js'
        import TrackView from './components/track.js'

        (async function main() {
            const claude = new Claude({
                shared: {
                    image: await io.imread('./assets/img/sea.jpg'),
                },
                layout: [[
                    new Component({
                        init: function () {
                            const bitmap = this.shared.image.bitmap
                            this.canvas.width = bitmap.width
                            this.canvas.height = bitmap.height
                            this.context.drawImage(bitmap, 0, 0, bitmap.width, bitmap.height)
                        },
                        pointermove: function (event) {
                            console.log(
                                this.shared.image.bitmap.width * event.offsetX / this.canvas.offsetWidth,
                                this.shared.image.bitmap.height * event.offsetY / this.canvas.offsetHeight,
                            )
                        }
                    }),
                    new TrackView({
                        init: function () {
                            this.canvas.width = window.innerWidth
                            this.canvas.height = window.innerHeight

                            /** Tools */
                            this.camera = new Camera({})
                            this.trackball = new Trackball({})
                            this.renderer = new Renderer({
                                vertex: TrackView.shaders.vertex,
                                fragment: TrackView.shaders.fragment,
                                context: this.canvas.getContext('webgl'),
                            })

                            const positions = this.shared.image.pixels
                            const colors = positions.slice()
                            const sizes = new Float32Array(positions.length / 3).fill(1)

                            for (let i = 0; i < positions.length; i += 3) {
                                positions[i + 0] -= 0.5
                                positions[i + 1] -= 0.5
                                positions[i + 2] -= 0.5
                            }

                            this.buffers = {
                                sizes: this.renderer.buffer({ array: sizes }),
                                colors: this.renderer.buffer({ array: colors }),
                                positions: this.renderer.buffer({ array: positions }),
                            }

                            this.camera.project()
                            this.camera.look()

                            this.render()
                        },
                        render: function () {
                            this.renderer.a_Color({ buffer: this.buffers.colors, size: 3 })
                            this.renderer.a_PointSize({ buffer: this.buffers.sizes, size: 1 })
                            this.renderer.a_Position({ buffer: this.buffers.positions, size: 3 })

                            this.renderer.u_ProjMatrix(this.camera.proj)
                            this.renderer.u_ViewMatrix(this.camera.view)
                            this.renderer.u_ModelMatrix(this.trackball.model)

                            this.renderer.draw({ mode: this.renderer.context.POINTS, count: this.shared.image.pixels.length / 3 })
                        }
                    })
                ]],
            })

        })()
    </script>
</body>

</html>